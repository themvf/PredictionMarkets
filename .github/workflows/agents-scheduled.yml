# Runs lower-frequency agents: discovery, analyzer, trader, insight
# Each agent runs as a separate parallel job so a slow agent doesn't block others.
#
# Schedule:
#   Discovery + Trader + Analyzer: every 30 minutes
#   Insight: every 60 minutes (runs only on the :05 cron)

name: Agents – Scheduled (Discovery, Analyzer, Trader, Insight)

on:
  schedule:
    - cron: "5 * * * *"      # Every hour at :05 — runs all agents including insight
    - cron: "35 * * * *"     # Every hour at :35 — runs discovery/analyzer/trader only
  workflow_dispatch:
    inputs:
      include_insight:
        description: "Also run the insight agent?"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

concurrency:
  group: agents-scheduled
  cancel-in-progress: false

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install -r requirements.txt

  discovery:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install -r requirements.txt
      - name: Run discovery agent
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: python run_agent.py discovery

  analyzer:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install -r requirements.txt
      - name: Run analyzer agent
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: python run_agent.py analyzer

  trader:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install -r requirements.txt
      - name: Run trader agent
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: python run_agent.py trader

  insight:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run on the :05 cron (once/hour) or manual dispatch
    if: >-
      github.event_name == 'workflow_dispatch' && inputs.include_insight == 'true'
      || github.event_name == 'schedule' && github.event.schedule == '5 * * * *'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install -r requirements.txt
      - name: Run insight agent
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: python run_agent.py insight
